---
title: An R Markdown document converted from "C:/Users/gq19765/OneDrive - University
  of Bristol/Documents/ICU PhD/LABMARCS/Data/ImprovedVisualisation.ipynb"
output:
  html_document: default
  pdf_document: default
---

# LABMARCS Visualisation
## Libraries

```{r}
library(ggplot2)
library(hrbrthemes)
library(tidyverse)
library(plotly)
library(BBmisc)
library(scales)
library(dplyr)
library(naniar)
library(gridExtra)
library(knitr)
library(moments)
library(formattable)
library(IRdisplay)
library(repr)
```

## Load in data files
### Outcome data
#### NBT Outcomes

```{r}
NBT_outcomes <- read.csv(file("NBT_outcomes.csv"))
NBT_outcomes = NBT_outcomes %>% 
  rename(
    admissionDate = admission_date,
  )
NBT_outcomes$admissionDate = as.Date(NBT_outcomes$admissionDate, format="%d/%m/%Y")
NBT_outcomes = NBT_outcomes %>% 
  rename(
    dischargeDate = discharge_date,
  )
NBT_outcomes$dischargeDate = as.Date(NBT_outcomes$dischargeDate, format="%d/%m/%Y")
NBT_outcomes_deaths = NBT_outcomes %>%
  filter(DischargeOutcomeDesc == "Patient Died")
NBT_outcomes_deaths$deathDate = NBT_outcomes_deaths$dischargeDate
NBT_outcomes <- merge(NBT_outcomes,NBT_outcomes_deaths,all=TRUE)
NBT_outcomes$ITU_Start = as.Date(NBT_outcomes$ITU_Start, format="%d/%m/%Y")
NBT_outcomes$ITU_End = as.Date(NBT_outcomes$ITU_End, format="%d/%m/%Y")
NBT_outcomes2 = NBT_outcomes %>% select(uob_ID,admissionDate,dischargeDate,ITU_Start,ITU_End,deathDate)
```

#### UHB Outcomes

```{r}
UHB_outcomes1 <- read.csv(file("UHB_outcomes1.csv"))
UHB_outcomes1 = UHB_outcomes1 %>% 
  rename(
    admissionDate = attend_date,
  )
UHB_outcomes1$admissionDate = as.Date(UHB_outcomes1$admissionDate, format="%d/%m/%Y")
UHB_outcomes1$dischargeDate = as.Date(UHB_outcomes1$admissionDate + as.integer(UHB_outcomes1$hospital_length_of_stay))
UHB_outcomes1 = UHB_outcomes1 %>% 
  rename(
    deathDate = fu_death_date,
  )
UHB_outcomes1$deathDate = as.Date(UHB_outcomes1$deathDate, format="%d/%m/%Y")
UHB_outcomes1$ITU_Start <- as.Date(NA)
UHB_outcomes1$ITU_End <- as.Date(NA)
UHB_outcomes12 = UHB_outcomes1 %>% select(uob_ID,admissionDate,dischargeDate,ITU_Start,ITU_End,deathDate)

UHB_outcomes2 <- read.csv(file("UHB_outcomes2.csv"))
UHB_outcomes2 = UHB_outcomes2 %>% 
  rename(
    admissionDate = attend_dte,
  )
UHB_outcomes2$admissionDate = as.Date(UHB_outcomes2$admissionDate, format="%d/%m/%Y")
UHB_outcomes2 = UHB_outcomes2 %>% 
  rename(
    dischargeDate = outcome_dte,
  )
UHB_outcomes2$dischargeDate = as.Date(UHB_outcomes2$dischargeDate, format="%d/%m/%Y")
UHB_outcomes2_deaths = UHB_outcomes2 %>%
  filter(outcome == 3)
UHB_outcomes2_deaths$deathDate = UHB_outcomes2_deaths$dischargeDate
UHB_outcomes2 <- merge(UHB_outcomes2,UHB_outcomes2_deaths,all=TRUE)
UHB_outcomes2$ITU_Start <- as.Date(NA)
UHB_outcomes2$ITU_End <- as.Date(NA)
UHB_outcomes22 = UHB_outcomes2 %>% select(uob_ID,admissionDate,dischargeDate,ITU_Start,ITU_End,deathDate)
```

#### Weston Outcomes

```{r}
WestonOutcomes <- read.csv(file("Weston.Outcomes.csv"))
WestonOutcomes = WestonOutcomes %>% 
  rename(
    admissionDate = Admission.date,
  )
WestonOutcomes$admissionDate = as.Date(WestonOutcomes$admissionDate, format="%d/%m/%Y")
WestonOutcomes = WestonOutcomes %>% 
  rename(
    dischargeDate = Discharge.date,
  )
WestonOutcomes$dischargeDate = as.Date(WestonOutcomes$dischargeDate, format="%d/%m/%Y")
WestonOutcomes = WestonOutcomes %>% 
  rename(
    ITU_Start = ICU.Admission.Date
  )
WestonOutcomes$ITU_Start = as.Date(WestonOutcomes$ITU_Start, format="%d/%m/%Y")
WestonOutcomes = WestonOutcomes %>% 
  rename(
    ITU_End = ICU.Discharge.Date
  )
WestonOutcomes$ITU_End = as.Date(WestonOutcomes$ITU_End, format="%d/%m/%Y")
WestonOutcomes = WestonOutcomes %>% 
  rename(
    deathDate = Date.of.Death
  )
WestonOutcomes$deathDate = as.Date(WestonOutcomes$deathDate, format="%d/%m/%Y")
WestonOutcomes2 = WestonOutcomes %>% select(uob_ID,admissionDate,dischargeDate,ITU_Start,ITU_End,deathDate)
```

### Merge Outcome data

```{r}
# Merge outcomes data
totalOutcomes <- rbind(UHB_outcomes12,UHB_outcomes22,NBT_outcomes2,WestonOutcomes2) # NBT Outcomes must be excluded as inconsistent
totalOutcomes$deathDate = as.Date(totalOutcomes$deathDate, format="%d/%m/%Y")
totalOutcomes$ITU_Start = as.Date(totalOutcomes$ITU_Start, format="%d/%m/%Y")
totalOutcomes$ITU_End = as.Date(totalOutcomes$ITU_End, format="%d/%m/%Y")
totalOutcomes$dischargeDate = as.Date(totalOutcomes$dischargeDate, format="%d/%m/%Y")
totalOutcomes = totalOutcomes %>% 
  rename(
    ID = uob_ID
  )
```


```{r}
## Demographics Table
dem <- read.csv(file("masterlist.csv"))
dem <- dem %>%
  rename(ID = uob_ID, Age = agecat) %>%
  distinct(ID, .keep_all = TRUE) %>%
  dplyr::select(ID,Gender,Age)

## Merge outcomes with demographics
total <- merge(totalOutcomes,dem, by = "ID")

# Remove those without admission information
total <- total %>% filter(!is.na(admissionDate))

# Missing discharge info
# Remove those without discharge information
total <- total %>% filter(!is.na(dischargeDate))

# Age less than 18
# Remove those less than 18
total <- total %>% filter(Age >= 18)

### Those that have died
deceasedSubset = subset(total, !is.na(total$deathDate))
deceasedSubset$died = TRUE

### Add new column for died / didn't die to total
total = merge(total,deceasedSubset, all.x = TRUE)
total$died[is.na(total$died)] <- FALSE

### Those that went to ICU
ICU_subset = subset(totalOutcomes, !is.na(totalOutcomes$ITU_Start))
ICU_subset$went_to_icu = TRUE

### Add new column for went to ICU / didn't go to ICU
total = merge(total,ICU_subset, all.x = TRUE)
total$went_to_icu[is.na(total$went_to_icu)] <- FALSE

### Died or went to ICU
total$severeOutcome[total$went_to_icu == TRUE | total$died == TRUE] <- TRUE
total$severeOutcome[is.na(total$severeOutcome)] <- FALSE


## Add FIRST covid-positive date
CovidCT <- read.csv(file("CovidCT.csv"))
CovidCT['Measure'] = 'CovidCT'
CovidCT$Specimen.Date = as.Date(CovidCT$Specimen.Date, format = "%d/%m/%Y")
CovidCT = CovidCT %>% 
  rename(
     ID = uob_ID,
     date = Specimen.Date,
  )

uniqueIDs = unique(CovidCT$ID)
CovidCT['positiveDate'] <- as.Date(NA)

for (i in uniqueIDs) {
  for (j in length(CovidCT$date[CovidCT$ID == i])) {
      CovidCT[CovidCT$ID == i,]$positiveDate <- as.Date(CovidCT[CovidCT$ID == i,]$date[1], 
                                                        format = "%d%m%Y")
  }
}

CovidCT <- CovidCT %>% dplyr::select(ID,positiveDate) %>% distinct()

total <- left_join(total,CovidCT)

# Number of people who have multiple admissions is 54 at this point
# Not sure how to treat but original assumption was to only use the original
# admission date info (so by default death is excluded )

# Only keep first admission
ctr <- 0
multi_admit_ids <- c()
for (id in unique(total$ID)) {
  id_match <- total$ID == id
  if (sum(id_match) > 1) {
    ctr <- ctr + 1
    multi_admit_ids[ctr] <- id
    total[id_match,] <- total[id_match,][1,]
  }
}
 
for (id in multi_admit_ids) {
  id_match <- total$ID == id
  #print(total[id_match,])
}

total <- unique(total)
```





### Load variable data 
#### BE - Bicarbonate Excess

```{r}
BE <- read.csv(file("BE.csv"))
BE$Date.Booked.In = as.Date(BE$Date.Booked.In, format="%d/%m/%Y")
BE = BE %>% 
  rename(
    date = Date.Booked.In,
  )
BE = BE %>%
  rename(
    BE_val = Numeric.Result
  )
```

#### BNP - B-type natriuretic peptide

```{r}
BNP <- read.csv(file("BNP.csv"))
BNP$Date.Booked.In = as.Date(BNP$Date.Booked.In, format="%d/%m/%Y")
BNP = BNP %>% 
  rename(
    date = Date.Booked.In,
  )
BNP = BNP %>%
  rename(
    BNP_val = Numeric.Result
  )
BNP_transform <- BNP
```

#### CRP - C-Reactive Protein

```{r}
CRP <- read.csv(file("CRP.csv"))
CRP$Date.Booked.In = as.Date(CRP$Date.Booked.In, format="%d/%m/%Y")
CRP = CRP %>% 
  rename(
    date = Date.Booked.In,
  )
CRP = CRP %>%
  rename(
    CRP_val = Numeric.Result
  )
```

#### CovidCT - Cycle Threshold (CT) value of PCR for COVID

```{r}
CovidCT <- read.csv(file("CovidCT.csv"))
CovidCT$Specimen.Date = as.Date(CovidCT$Specimen.Date, format="%d/%m/%Y")
CovidCT = CovidCT %>% 
  rename(
    date = Specimen.Date,
  )
```

#### DDM - D-Dimer 

```{r}
DDM <- read.csv(file("DDM.csv"))
DDM$Date.Booked.In = as.Date(DDM$Date.Booked.In, format="%d/%m/%Y")
DDM = DDM %>% 
  rename(
    date = Date.Booked.In,
  )
DDM = DDM %>%
  rename(
    DDM_val = Numeric.Result
  )
```

#### eGFR - Estimated Glomerular Filtration Rate

```{r}
eGFR <- read.csv(file("eGFR.csv"))
eGFR$Date.Booked.In = as.Date(eGFR$Date.Booked.In, format="%d/%m/%Y")
eGFR = eGFR %>% 
  rename(
    date = Date.Booked.In,
  )
eGFR = eGFR %>%
  rename(
    eGFR_val = Numeric.Result
  )
```

#### FER - Ferritin

```{r}
FER <- read.csv(file("FER.csv"))
FER$Date.Booked.In = as.Date(FER$Date.Booked.In, format="%d/%m/%Y")
FER = FER %>% 
  rename(
    date = Date.Booked.In,
  )
FER = FER %>%
  rename(
    FER_val = Numeric.Result
  )
```

#### Fib - Fibrinogen

```{r}
fib <- read.csv(file("fib.csv"))
fib$Date.Booked.In = as.Date(fib$Date.Booked.In, format="%d/%m/%Y")
fib = fib %>% 
  rename(
    date = Date.Booked.In,
  )
fib = fib %>%
  rename(
    fib_val = Numeric.Result
  )
```

#### Glucose

```{r}
Glucose <- read.csv(file("Glucose.csv"))
Glucose$Date.Booked.In = as.Date(Glucose$Date.Booked.In, format="%d/%m/%Y")
Glucose = Glucose %>% 
  rename(
    date = Date.Booked.In,
  )
Glucose = Glucose %>%
  rename(
    Glucose_val = Numeric.Result
  )
```

#### HB - Hemoglobin

```{r}
HB <- read.csv(file("HB.csv"))
HB$Date.Booked.In = as.Date(HB$Date.Booked.In, format="%d/%m/%Y")
HB = HB %>% 
  rename(
    date = Date.Booked.In,
  )
HB = HB %>%
  rename(
    HB_val = Numeric.Result
  )
```

#### HBA1c - glycated haemoglobin

```{r}
HBA1c <- read.csv(file("HBA1c.csv"))
HBA1c$Date.Booked.In = as.Date(HBA1c$Date.Booked.In, format="%d/%m/%Y")
HBA1c = HBA1c %>% 
  rename(
    date = Date.Booked.In,
  )
HBA1c = HBA1c %>%
  rename(
    HBA1c_val = Numeric.Result
  )
```

#### LDH - Lactate dehydrogenase

```{r}
LDH <- read.csv(file("LDH.csv"))
LDH$Date.Booked.In = as.Date(LDH$Date.Booked.In, format="%d/%m/%Y")
LDH = LDH %>% 
  rename(
    date = Date.Booked.In,
  )
LDH = LDH %>%
  rename(
    LDH_val = Numeric.Result
  )
```

#### PCT - Procalcitonin 

```{r}
PCT <- read.csv(file("PCT.csv"))
PCT$Date.Booked.In = as.Date(PCT$Date.Booked.In, format="%d/%m/%Y")
PCT = PCT %>% 
  rename(
    date = Date.Booked.In,
  )
PCT = PCT %>%
  rename(
    PCT_val = Numeric.Result
  )
```

#### PLT - Platelet Count

```{r}
PLT <- read.csv(file("PLT.csv"))
PLT$Date.Booked.In = as.Date(PLT$Date.Booked.In, format="%d/%m/%Y")
PLT = PLT %>% 
  rename(
    date = Date.Booked.In,
  )
PLT = PLT %>%
  rename(
    PLT_val = Numeric.Result
  )
```

#### Trig - Triglycerides

```{r}
trig <- read.csv(file("trig.csv"))
trig$Date.Booked.In = as.Date(trig$Date.Booked.In, format="%d/%m/%Y")
trig = trig %>% 
  rename(
    date = Date.Booked.In,
  )
trig = trig %>%
  rename(
    trig_val = Numeric.Result
  )
```

#### Trop - Troponin

```{r}
trop <- read.csv(file("trop.csv"))
trop$Date.Booked.In = as.Date(trop$Date.Booked.In, format="%d/%m/%Y")
trop = trop %>% 
  rename(
    date = Date.Booked.In,
  )
trop = trop %>%
  rename(
    trop_val = Numeric.Result
  )
```

#### Vir - Virology

```{r}
Vir <- read.csv(file("Vir.csv"))
Vir$Sample.Date = as.Date(Vir$Sample.Date, format="%d/%m/%Y")
Vir = Vir %>% 
  rename(
    date = Sample.Date,
  )
Vir = Vir %>% 
  rename(
    Adenovirus = Adenovirus..PCR.,
  )
Vir = Vir %>% 
  rename(
    Human_Metapneumovirus = Human.metapneumovirus..PCR.,
  )
Vir = Vir %>% 
  rename(
    Influenza_A = Influenza.A..PCR.,
  )
Vir = Vir %>% 
  rename(
    Influenza_B = Influenza.B..PCR.,
  )
Vir = Vir %>% 
  rename(
    Parainfluenza_Type_1 = Parainfluenza.Type.1..PCR.,
  )
Vir = Vir %>% 
  rename(
    Parainfluenza_Type_2 = Parainfluenza.Type.2..PCR.,
  )
Vir = Vir %>% 
  rename(
    Parainfluenza_Type_3 = Parainfluenza.Type.3..PCR.,
  )
Vir = Vir %>% 
  rename(
    Parainfluenza_Type_4 = Parainfluenza.Type.4..PCR.,
  )
Vir = Vir %>% 
  rename(
    Respiratory_Syncytial_Virus = Respiratory.Syncytial.Virus..PCR.,
  )
Vir = Vir %>% 
  rename(
    Rhinovirus = Rhinovirus..PCR.,
  )
```

#### FBC - Full Blood Count
Made up of:
* Lymphocytes
* Neutrophils
* White Cell Count

```{r}
FBC <- read.csv(file("FBC.csv"))
FBC$Date.Booked.In = as.Date(FBC$Date.Booked.In, format="%d/%m/%Y")
FBC = FBC %>% 
  rename(
    date = Date.Booked.In,
  )
```

Split off Lymphocytes:

```{r}
FBCLymph = FBC %>% select(uob_ID,date,Result.Lymphocytes)
FBCLymph = FBCLymph %>% 
  rename(
    Lymphocytes = Result.Lymphocytes,
  )
```

Split off Neutrophils:

```{r}
FBCNeutr = FBC %>% select(uob_ID,date,Result.Neutrophils)
FBCNeutr = FBCNeutr %>% 
  rename(
    Neutrophils = Result.Neutrophils,
  )
```

Split off White Cell Count:

```{r}
FBCWCC = FBC %>% select(uob_ID,date,Result.WCC)
FBCWCC = FBCWCC %>% 
  rename(
    WCC = Result.WCC,
  )
```

Split off Neutrophil to Lymphocyte Ratio

```{r}
FBCNLR = FBC %>% select(uob_ID,date,NLR)
FBCNLR = FBCNLR %>% 
  rename(
    NLR_val = NLR,
  )
```


#### Clot
Made up of:
* APTT - Activated Partial Thromboplastin Time
* PT - Prothrombin Time

```{r}
Clot <- read.csv(file("Clot.csv"))
Clot$Date.Booked.In = as.Date(Clot$Date.Booked.In, format="%d/%m/%Y")
Clot = Clot %>% 
  rename(
    date = Date.Booked.In,
  )
```

Split off APTT:

```{r}
ClotAPTT = Clot %>% select(uob_ID,date,APTT)
ClotAPTT = ClotAPTT %>% 
  rename(
    APTT_val = APTT,
  )
```

Split off PT:

```{r}
ClotPT = Clot %>% select(uob_ID,date,PT)
ClotPT = ClotPT %>% 
  rename(
    PT_val = PT,
  )
```

#### Antigen 

```{r}
Antigen <- read.csv(file("Antigen.csv"))
Antigen = Antigen %>% 
  rename(
    date = Date.of.Specimen,
  )
```

#### BC

```{r}
BC <- read.csv(file("BC.csv"))
BC$Date.of.Specimen = as.Date(BC$Date.of.Specimen, format="%d/%m/%Y")
BC = BC %>% 
  rename(
    date = Date.of.Specimen,
  )
```

#### Resp

```{r}
Resp <- read.csv(file("Resp.csv"))
Resp$Date.of.Specimen = as.Date(Resp$Date.of.Specimen, format="%d/%m/%Y")
Resp = Resp %>% 
  rename(
    date = Date.of.Specimen,
  )
```

#### Urine

```{r}
Urine <- read.csv(file("Urine.csv"))
Urine$Date.of.Specimen = as.Date(Urine$Date.of.Specimen, format="%d/%m/%Y")
Urine = Urine %>% 
  rename(
    date = Date.of.Specimen,
  )
```

#### poctLAC - Point of Care Testing - Lactate

```{r}
poctLAC <- read.csv(file("poctLAC.csv"))
#Format date
poctLAC$Date.of.Specimen = as.Date(poctLAC$Date.of.Specimen, format="%d/%m/%Y")
poctLAC = poctLAC %>% 
  rename(
    date = Date.of.Specimen,
  )
poctLAC = poctLAC %>% 
  rename(
    time = Time.of.Specimen,
  )
poctLAC = poctLAC %>%
  rename(
    poctLAC_val = Numeric.Result
  )
#Combine date and time
poctLAC$dateTime = as.POSIXct(paste(poctLAC$date, poctLAC$time), format="%Y-%m-%d %H:%M:%S")
# Select relevant variables
```

#### poctO2 - Point of Care Testing - O2 and CO2
Made up of:
* O2
* CO2

```{r}
poctO2 <- read.csv(file("poctO2.csv"))
```

O2:

```{r}
O2 <- poctO2 %>%
  filter(Test.Desc == "Arterial pO2")
O2$Date.of.Specimen = as.Date(O2$Date.of.Specimen, format="%d/%m/%Y")
O2 = O2 %>% 
  rename(
    date = Date.of.Specimen,
  )
O2 = O2 %>% 
  rename(
    time = Time.of.Specimen,
  )
O2 = O2 %>% 
  rename(
    O2_val = Numeric.Result,
  )
#Combine date and time
O2$dateTime = as.POSIXct(paste(O2$date, O2$time), format="%Y-%m-%d %H:%M:%S")
```

CO2:

```{r}
CO2 <- poctO2 %>%
  filter(Test.Desc == "Arterial pCO2")
#Format date
CO2$Date.of.Specimen = as.Date(CO2$Date.of.Specimen, format="%d/%m/%Y")
CO2 = CO2 %>% 
  rename(
    date = Date.of.Specimen,
  )
CO2 = CO2 %>% 
  rename(
    time = Time.of.Specimen,
  )
CO2 = CO2 %>% 
  rename(
    CO2_val = Numeric.Result,
  )
#Combine date and time
CO2$dateTime = as.POSIXct(paste(CO2$date, CO2$time), format="%Y-%m-%d %H:%M:%S")
```

#### poctpH - Point of Care Testing - pH

```{r}
poctpH <- read.csv(file("poctpH.csv"))
#Format date
poctpH$Date.of.Specimen = as.Date(poctpH$Date...Time.of.Specimen, format="%d/%m/%Y")
poctpH = poctpH %>% 
  rename(
    date = Date...Time.of.Specimen,
  )
poctpH = poctpH %>% 
  rename(
    time = Time.of.Specimen,
  )
poctpH = poctpH %>% 
  rename(
    poctpH_val = Numeric.Result,
  )
#Combine date and time
poctpH$dateTime = as.POSIXct(paste(poctpH$date, poctpH$time), format="%Y-%m-%d %H:%M:%S")
```

## AvonCap

```{r}
AvonCap <- read.csv(file("AvonCap.csv"))
AvonCap = AvonCap %>%
    rename(
        Community_Acquired_Pneumonia_radiologically_confirmed = Final.Standard.of.Care.LRTD.related.diagnosis..choice.CAP...radiologically.confirmed.,
        Community_Acquired_Pneumonia_clinically_confirmed = Final.Standard.of.Care.LRTD.related.diagnosis..choice.CAP...clinically.confirmed..but.not.on.radiology..,
        Community_Acquired_Pneumonia_no_radiology_performed = Final.Standard.of.Care.LRTD.related.diagnosis..choice.CAP...no.radiology.performed.,
        Acute_bronchitis = Final.Standard.of.Care.LRTD.related.diagnosis..choice.Acute.bronchitis.,
        Exacerbation_of_COPD = Final.Standard.of.Care.LRTD.related.diagnosis..choice.Exacerbation.of.COPD.,
        Empyema_lung_abscess = Final.Standard.of.Care.LRTD.related.diagnosis..choice.Empyema.lung.abscess.,
        LRTI_not_further_specified = Final.Standard.of.Care.LRTD.related.diagnosis..choice.LRTI...not.further.specified.,
        Congestive_heart_failure = Final.Standard.of.Care.LRTD.related.diagnosis..choice.Congestive.heart.failure.,
        Non_infectious_process = Final.Standard.of.Care.LRTD.related.diagnosis..choice.Non.infectious.process.,
        Non_LRTD_infection_related_diagnosis = Final.Standard.of.Care.LRTD.related.diagnosis..choice.Non.LRTD.infection.related.diagnosis.,
        Other_LRTI_specified = Other.LRTI.Specified,
        NYHA_Heart_failure = NYHA...Heart.Failure..nbsp.,
        CRB65_Score = CRB65.Score,
        NEWS2_Score = NEWS.2.Score,
        Respiratory_Disease_None = Respiratory.Disease..choice.None.,
        COPD = Respiratory.Disease..choice.COPD..Chronic.Obstructive.Pulmonary.Disease.Emphysema..,
        Asthma = Respiratory.Disease..choice.Asthma.,
        Bronchiectasis = Respiratory.Disease..choice.Bronchiectasis.,
        Pulmonary_Fibrosis_Interstitial_Lung_Disease = Respiratory.Disease..choice.Pulmonary.Fibrosis.Interstitial.Lung.Disease.,
        Respiratory_Disease_other = Respiratory.Disease..choice.Other.,
        Chronic_heart_disease_none = Chronic.Heart.Disease..choice.None.,
        Hypertension = Chronic.Heart.Disease..choice.Hypertension.,
        Atrial_Fibrillation = Chronic.Heart.Disease..choice.Atrial.Fibrillation.,
        Ischaemic_heart_disease = Chronic.Heart.Disease..choice.Ischaemic.heart.disease.,
        Heart_failure = Chronic.Heart.Disease..choice.Heart.failure.CCF.,
        Chronic_heart_disease_other = Chronic.Heart.Disease..choice.Other.,
        Chronic_Kidney_Disease = Chronic.Kidney.Disease..CKD..Mod.Severe..eGFR..30..Cr.265.umol.L..dialysis..transplantation..uremic.syndrome,
        Liver_disease = Liver.Disease.Mild...nbsp.cirrhosis.without.portal.HTN..chronic.hepatitis..Mod.Severe...nbsp.cirrhosis.with.portal.HTN.....variceal.bleeding,
        Diabetes = Diabetes,
        Cognitive_Impairment_Dementia_none = Cognitive.Impairment.Dementia..choice.None.,
        Dementia = Cognitive.Impairment.Dementia..choice.Dementia.,
        Cognitive_impairment = Cognitive.Impairment.Dementia..choice.Cognitive.Impairment.,
        CVA_Stroke = Cognitive.Impairment.Dementia..choice.CVA..stroke..,
        TIA_mini_stroke = Cognitive.Impairment.Dementia..choice.TIA..mini.stroke..,
        Hemiplegiahemiplegia_or_paraplegia = Hemiplegiahemiplegia.or.paraplegia,
        Peripheral_vascular_disease = Peripheral.Vascular.Disease.Intermittent.claudication..periph..arterial.bypass.for.insufficiency..gangrene..acute.arterial.insufficiency..untreated.aneurysm....6cm..nbsp.,
        Immunosuppressive_medication = Immunosuppressive.Medication.includes.oral.steroids..biologics..chemotherapy.,
        Immunodeficiency = Immunodeficiency.eg.SCID..hypogammaglobulinaemia..splenectomy.,
        Connective_tissue_disease = Connective.Tissue.Disease..SLE..polymyositis..mixed.nbsp.Connective.Tissue.Disease..polymyalgia.rheumatica..moderate.to.severe.Rheumatoid.Arthritis.,
        HIV_negative_or_not_tested = HIV.status..choice.Negative..no.HIV...or.not.tested.,
        HIV_positive = HIV.status..choice.HIV.,
        AIDS = HIV.status..choice.AIDS.,
        Solid_organ_cancer_malignancy = Solid.Organ.Cancer.Malignancy.Initially.treated.in.the.last.5.years.exclude.non.melanomatous.skin.cancers.and.in.situ.cervical.carcinoma,
        Haematological_malignancy_leukaemia_none = Haematological.Malignancy.Leukaemia...nbsp.CML..CLL..AML..ALL..Polycythaemia.Vera.Lymphoma...nbsp.NHL..Hodgkin.s..WaldenstrÃ.m..multiple.myeloma...choice.None.,
        Leukaemia = Haematological.Malignancy.Leukaemia...nbsp.CML..CLL..AML..ALL..Polycythaemia.Vera.Lymphoma...nbsp.NHL..Hodgkin.s..WaldenstrÃ.m..multiple.myeloma...choice.Leukaemia.,
        Lymphoma = Haematological.Malignancy.Leukaemia...nbsp.CML..CLL..AML..ALL..Polycythaemia.Vera.Lymphoma...nbsp.NHL..Hodgkin.s..WaldenstrÃ.m..multiple.myeloma...choice.Lymphoma.,
        Organ_transplantation = Organ.Transplantation,
        Pregnancy_post_partum = Pregnancy.Post.partum,
        Gastric_Duodenal_Ulcer_disease = Gastric.Duodenal.Ulcer.Disease.Patients.who.have.required.treatment.for.PUD.nbsp.,
        Rockwood_frailty_score = Rockwood.Frailty.Score,
        Radiology_result = Radiology.Result
    )
```

## Demographics Table
Age and gender for every individual

```{r}
dem <- read.csv("masterlist.csv")
dem = dem %>%
  distinct(uob_ID, .keep_all = TRUE)
dem = dem %>%
  select(uob_ID,Gender,agecat)
dem = dem %>% 
  rename (Age = agecat)
```

## Distribution transformations

```{r}
# BE_transform <- subset(BE, BE_val < 57.5)
# BNP_transform <- BNP
# BNP_transform$BNP_val <- log10(BNP_transform$BNP_val)
# ClotAPTT_transform <- ClotAPTT
# ClotAPTT_transform$APTT_val <- log10(ClotAPTT_transform$APTT_val)
# ClotPT_transform <- ClotPT
# ClotPT_transform$PT_val <- log10(ClotPT_transform$PT_val)
# CO2_transform <- CO2
# CO2_transform$CO2_val <- log10(CO2_transform$CO2_val)
# O2_transform <- O2
# O2_transform$O2_val <- log10(O2_transform$O2_val)
# CRP_transform <- CRP
# CRP_transform$CRP_val <- (CRP_transform$CRP_val)^(1/3)
# DDM_transform <- DDM
# DDM_transform$DDM_val <- log10(DDM_transform$DDM_val)
# eGFR_transform <- eGFR
# FBCLymph_transform <- FBCLymph
# FBCLymph_transform$Lymphocytes <- log10(FBCLymph_transform$Lymphocytes)
# FBCNeutr_transform <- FBCNeutr
# FBCNeutr_transform$Neutrophils <- (FBCNeutr_transform$Neutrophils)^(1/3)
# FBCNLR_transform <- FBCNLR
# FBCNLR_transform$NLR_val <- log10(FBCNLR_transform$NLR_val)
# FBCWCC_transform <- FBCWCC
# FBCWCC_transform$WCC <- (FBCWCC_transform$WCC)^(1/3)
# FER_transform <- FER
# FER_transform$FER_val <- log10(FER_transform$FER_val)
# fib_transform <- fib
# Glucose_transform <- Glucose
# Glucose_transform$Glucose_val <- log10(Glucose_transform$Glucose_val)
# HB_transform <- HB
# HBA1c_transform <- HBA1c
# HBA1c_transform$HBA1c_val <- (HBA1c_transform$HBA1c_val)^(1/3)
# LDH_transform <- LDH
# LDH_transform$LDH_val <- log10(LDH_transform$LDH_val)
# PCT_transform <- PCT
# PCT_transform$PCT_val <- log10(PCT_transform$PCT_val)
# PLT_transform <- PLT
# PLT_transform$PLT_val <- sqrt(PLT_transform$PLT_val)
# poctLAC_transform <- poctLAC
# poctLAC_transform$poctLAC_val <- log10(poctLAC_transform$poctLAC_val)
# poctpH_transform <- poctpH
# trig_transform <- trig
# trig_transform$trig_val <- log10(trig_transform$trig_val)
# trop_transform <- trop
# trop_transform$trop_val <- log10(trop_transform$trop_val)
```

### Subset tables 

```{r}
BE = BE %>% select(uob_ID,date,BE_val)
BNP = BNP %>% select(uob_ID,date,BNP_val)
CRP = CRP %>% select(uob_ID,date,CRP_val)
DDM = DDM %>% select(uob_ID,date,DDM_val)
eGFR = eGFR %>% select(uob_ID,date,eGFR_val)
FER = FER %>% select(uob_ID,date,FER_val)
fib = fib %>% select(uob_ID,date,fib_val)
Glucose = Glucose %>% select(uob_ID,date,Glucose_val)
HB = HB %>% select(uob_ID,date,HB_val)
ClotAPTT = ClotAPTT %>% select(uob_ID,date,APTT_val)
ClotPT = ClotPT %>% select(uob_ID,date,PT_val)
CO2 = CO2 %>% select(uob_ID,date,CO2_val)
O2 = O2 %>% select(uob_ID,date,O2_val)
FBCLymph = FBCLymph %>% select(uob_ID,date,Lymphocytes)
FBCNeutr = FBCNeutr %>% select(uob_ID,date,Neutrophils)
FBCNLR = FBCNLR %>% select(uob_ID,date,NLR_val)
FBCWCC = FBCWCC %>% select(uob_ID,date,WCC)
HBA1c = HBA1c %>% select(uob_ID,date,HBA1c_val)
poctpH = poctpH %>% select(uob_ID,date,poctpH_val)
poctpH$date = as.Date(poctpH$date, format="%d/%m/%Y")
poctLAC = poctLAC %>% select(uob_ID,date,poctLAC_val)
LDH = LDH %>% select(uob_ID,date,LDH_val)
PCT = PCT %>% select(uob_ID,date,PCT_val)
PLT = PLT %>% select(uob_ID,date,PLT_val)
trig = trig %>% select(uob_ID,date,trig_val)
trop = trop %>% select(uob_ID,date,trop_val)

```


### Calculate median for each patient-date
```{r}
# Group  by both patient and date. For each set of values for a specific date and ID, find the median. This will lead to a table with one row per patient-date
BE <- BE %>% group_by(uob_ID,date) %>% summarize(BE_val = median(BE_val))
BNP <- BNP %>% group_by(uob_ID,date) %>% summarize(BNP_val = median(BNP_val))
ClotAPTT <- ClotAPTT %>% group_by(uob_ID,date) %>% summarize(APTT_val = median(APTT_val))
ClotPT <- ClotPT %>% group_by(uob_ID,date) %>% summarize(PT_val = median(PT_val))
CO2 <- CO2 %>% group_by(uob_ID,date) %>% summarize(CO2_val = median(CO2_val))
CRP <- CRP %>% group_by(uob_ID,date) %>% summarize(CRP_val = median(CRP_val))
DDM <- DDM %>% group_by(uob_ID,date) %>% summarize(DDM_val = median(DDM_val))
eGFR <- eGFR %>% group_by(uob_ID,date) %>% summarize(eGFR_val = median(eGFR_val))
FBCLymph <- FBCLymph %>% group_by(uob_ID,date) %>% summarize(Lymphocytes = median(Lymphocytes))
FBCNeutr <- FBCNeutr %>% group_by(uob_ID,date) %>% summarize(Neutrophils = median(Neutrophils))
FBCNLR <- FBCNLR %>% group_by(uob_ID,date) %>% summarize(NLR_val = median(NLR_val))
FBCWCC <- FBCWCC %>% group_by(uob_ID,date) %>% summarize(WCC = median(WCC))
FER <- FER %>% group_by(uob_ID,date) %>% summarize(FER_val = median(FER_val))
fib <- fib %>% group_by(uob_ID,date) %>% summarize(fib_val = median(fib_val))
Glucose <- Glucose %>% group_by(uob_ID,date) %>% summarize(Glucose_val = median(Glucose_val))
HB <- HB %>% group_by(uob_ID,date) %>% summarize(HB_val = median(HB_val))
HBA1c <- HBA1c %>% group_by(uob_ID,date) %>% summarize(HBA1c_val = median(HBA1c_val))
LDH <- LDH %>% group_by(uob_ID,date) %>% summarize(LDH_val = median(LDH_val))
O2 <- O2 %>% group_by(uob_ID,date) %>% summarize(O2_val = median(O2_val))
PCT <- PCT %>% group_by(uob_ID,date) %>% summarize(PCT_val = median(PCT_val))
PLT <- PLT %>% group_by(uob_ID,date) %>% summarize(PLT_val = median(PLT_val))
poctLAC <- poctLAC %>% group_by(uob_ID,date) %>% summarize(poctLAC_val = median(poctLAC_val))
poctpH <- poctpH %>% group_by(uob_ID,date) %>% summarize(poctpH_val = median(poctpH_val))
trig <- trig %>% group_by(uob_ID,date) %>% summarize(trig_val = median(trig_val))
trop <- trop %>% group_by(uob_ID,date) %>% summarize(trop_val = median(trop_val))



```




### Put data into long format
- Each row is one time point per subject
- Each column is one variable
- Problem here is that there are too many measurements on one day. For vitals, we are just looking at one date, despite there being many measurements each day. For example, 30 measurements on one day for one patient. So that patient will have 30 dates. Next time a variable is added with say 30 dates, each of those 30 dates will also be populated with more. Either need:
- To make allowances for multiple readings per day
- Increase granularity of measurements (for O2, CO2 etc). Only trouble with this is that there are unlikely to be shared times for each patient.
- Could summarise reading for each day. Mean? 
- Could we look at readings per "patient-day" for each variable? 


```{r}

labmarcs_long <- BE %>% full_join(BNP, by=c("uob_ID","date"))
labmarcs_long <- labmarcs_long %>% full_join(ClotAPTT, by=c("uob_ID","date"))
labmarcs_long <- labmarcs_long %>% full_join(ClotPT, by=c("uob_ID","date"))
labmarcs_long <- labmarcs_long %>% full_join(CO2, by=c("uob_ID","date"))
labmarcs_long <- labmarcs_long %>% full_join(CRP, by=c("uob_ID","date"))
labmarcs_long <- labmarcs_long %>% full_join(DDM, by=c("uob_ID","date"))
labmarcs_long <- labmarcs_long %>% full_join(eGFR, by=c("uob_ID","date"))
labmarcs_long <- labmarcs_long %>% full_join(FBCLymph, by=c("uob_ID","date"))
labmarcs_long <- labmarcs_long %>% full_join(FBCNeutr, by=c("uob_ID","date"))
labmarcs_long <- labmarcs_long %>% full_join(FBCNLR, by=c("uob_ID","date"))
labmarcs_long <- labmarcs_long %>% full_join(FBCWCC, by=c("uob_ID","date"))
labmarcs_long <- labmarcs_long %>% full_join(FER, by=c("uob_ID","date"))
labmarcs_long <- labmarcs_long %>% full_join(fib, by=c("uob_ID","date"))
labmarcs_long <- labmarcs_long %>% full_join(Glucose, by=c("uob_ID","date"))
labmarcs_long <- labmarcs_long %>% full_join(HB, by=c("uob_ID","date"))
labmarcs_long <- labmarcs_long %>% full_join(HBA1c, by=c("uob_ID","date"))
labmarcs_long <- labmarcs_long %>% full_join(LDH, by=c("uob_ID","date"))
labmarcs_long <- labmarcs_long %>% full_join(O2, by=c("uob_ID","date"))
labmarcs_long <- labmarcs_long %>% full_join(PCT, by=c("uob_ID","date"))
labmarcs_long <- labmarcs_long %>% full_join(PLT, by=c("uob_ID","date"))
labmarcs_long <- labmarcs_long %>% full_join(poctLAC, by=c("uob_ID","date"))
labmarcs_long <- labmarcs_long %>% full_join(poctpH, by=c("uob_ID","date"))
labmarcs_long <- labmarcs_long %>% full_join(trig, by=c("uob_ID","date"))
labmarcs_long <- labmarcs_long %>% full_join(trop, by=c("uob_ID","date"))
```

### Merge with characteristics

```{r}
labmarcs_long = labmarcs_long %>% 
  rename(
    ID = uob_ID
  )
labmarcs_long <- labmarcs_long %>% full_join(total, by=c("ID"))
```

### Add length of stay column
- For days since covid +ve test
- For days since admission
```{r}
# Days since +ve test
labmarcs_long <- labmarcs_long %>% mutate(length_of_stay_pos = as.numeric(difftime(date,positiveDate,units="days")))

# Days since admission
labmarcs_long <- labmarcs_long %>% mutate(length_of_stay_adm = as.numeric(difftime(date,admissionDate,units="days")))

```

### Subset data based on length of stay
```{r}
# Remove irrelevant variables 
labmarcs_missing <- labmarcs_long %>% select(ID,BE_val,BNP_val,APTT_val,PT_val,PT_val,CO2_val,CRP_val,DDM_val,eGFR_val,Lymphocytes,Neutrophils,NLR_val,WCC,FER_val,fib_val,Glucose_val,HB_val,HBA1c_val,LDH_val,O2_val,PCT_val,PLT_val,poctLAC_val,poctpH_val,trig_val,trop_val,length_of_stay_adm,length_of_stay_pos)


# 1 day since positive 
labmarcs_1day_pos <- labmarcs_missing %>% filter(between(length_of_stay_pos,0,0))
labmarcs_1day_pos <- labmarcs_1day_pos %>% select(ID,length_of_stay_pos,BE_val,BNP_val,APTT_val,PT_val,PT_val,CO2_val,CRP_val,DDM_val,eGFR_val,Lymphocytes,Neutrophils,NLR_val,WCC,FER_val,fib_val,Glucose_val,HB_val,HBA1c_val,LDH_val,O2_val,PCT_val,PLT_val,poctLAC_val,poctpH_val,trig_val,trop_val)

# 3 days since positive
labmarcs_3day_pos <- labmarcs_missing %>% filter(between(length_of_stay_pos,0,2))
labmarcs_3day_pos <- labmarcs_3day_pos %>% select(ID,length_of_stay_pos,BE_val,BNP_val,APTT_val,PT_val,PT_val,CO2_val,CRP_val,DDM_val,eGFR_val,Lymphocytes,Neutrophils,NLR_val,WCC,FER_val,fib_val,Glucose_val,HB_val,HBA1c_val,LDH_val,O2_val,PCT_val,PLT_val,poctLAC_val,poctpH_val,trig_val,trop_val)

# 5 days since positive 
labmarcs_5day_pos <- labmarcs_missing %>% filter(between(length_of_stay_pos,0,4))
labmarcs_5day_pos <- labmarcs_5day_pos %>% select(ID,length_of_stay_pos,BE_val,BNP_val,APTT_val,PT_val,PT_val,CO2_val,CRP_val,DDM_val,eGFR_val,Lymphocytes,Neutrophils,NLR_val,WCC,FER_val,fib_val,Glucose_val,HB_val,HBA1c_val,LDH_val,O2_val,PCT_val,PLT_val,poctLAC_val,poctpH_val,trig_val,trop_val)

# 7 days since positive
labmarcs_7day_pos <- labmarcs_missing %>% filter(between(length_of_stay_pos,0,6))
labmarcs_7day_pos <- labmarcs_7day_pos %>% select(ID,length_of_stay_pos,BE_val,BNP_val,APTT_val,PT_val,PT_val,CO2_val,CRP_val,DDM_val,eGFR_val,Lymphocytes,Neutrophils,NLR_val,WCC,FER_val,fib_val,Glucose_val,HB_val,HBA1c_val,LDH_val,O2_val,PCT_val,PLT_val,poctLAC_val,poctpH_val,trig_val,trop_val)

# 14 days since positive
labmarcs_14day_pos <- labmarcs_missing %>% filter(between(length_of_stay_pos,0,13))
labmarcs_14day_pos <- labmarcs_14day_pos %>% select(ID,length_of_stay_pos,BE_val,BNP_val,APTT_val,PT_val,PT_val,CO2_val,CRP_val,DDM_val,eGFR_val,Lymphocytes,Neutrophils,NLR_val,WCC,FER_val,fib_val,Glucose_val,HB_val,HBA1c_val,LDH_val,O2_val,PCT_val,PLT_val,poctLAC_val,poctpH_val,trig_val,trop_val)


# 14 days since admission (purpose is to assess pattern of measurements)
labmarcs_14day_adm <- labmarcs_missing %>% filter(between(length_of_stay_adm,0,13))
labmarcs_14day_adm <- labmarcs_14day_adm %>% select(ID,length_of_stay_adm,BE_val,BNP_val,APTT_val,PT_val,PT_val,CO2_val,CRP_val,DDM_val,eGFR_val,Lymphocytes,Neutrophils,NLR_val,WCC,FER_val,fib_val,Glucose_val,HB_val,HBA1c_val,LDH_val,O2_val,PCT_val,PLT_val,poctLAC_val,poctpH_val,trig_val,trop_val)

# Drop irrelevant column

# Write dataframes to csv
write.csv(labmarcs_1day_pos, "imp_input/labmarcs_1day_pos.csv")
write.csv(labmarcs_3day_pos, "imp_input/labmarcs_3day_pos.csv")
write.csv(labmarcs_5day_pos, "imp_input/labmarcs_5day_pos.csv")
write.csv(labmarcs_7day_pos, "imp_input/labmarcs_7day_pos.csv")
write.csv(labmarcs_14day_pos, "imp_input/labmarcs_14day_pos.csv")

```


### Visualise missingness
```{r}



# Missingness for admission
labmarcs_14day_adm$length_of_stay_adm <- as.factor(labmarcs_14day_adm$length_of_stay_adm)
gg_miss_fct(labmarcs_14day_adm,length_of_stay_adm)

# Missingness for covid positive date
labmarcs_3day_pos$length_of_stay_pos <- as.factor(labmarcs_3day_pos$length_of_stay_pos)
gg_miss_fct(labmarcs_3day_pos,length_of_stay_pos)

labmarcs_5day_pos$length_of_stay_pos <- as.factor(labmarcs_5day_pos$length_of_stay_pos)
gg_miss_fct(labmarcs_5day_pos,length_of_stay_pos)

labmarcs_7day_pos$length_of_stay_pos <- as.factor(labmarcs_7day_pos$length_of_stay_pos)
gg_miss_fct(labmarcs_7day_pos,length_of_stay_pos)

labmarcs_14day_pos$length_of_stay_pos <- as.factor(labmarcs_14day_pos$length_of_stay_pos)
gg_miss_fct(labmarcs_14day_pos,length_of_stay_pos)
```

### Other missingness plots
```{r}
gg_miss_upset(labmarcs_14day_adm, order.by = "freq", nsets=29, nintersects=50)
```



### Put data into wide format
- Each row is one patient
- Each column one time point per variable

```{r}
# data_merge1 <- rbind(BE_transform,
#                      BNP_transform,
#                      ClotAPTT_transform,
#                      ClotPT_transform,
#                      CO2_transform,
#                      CRP_transform,
#                      DDM_transform,
#                      eGFR_transform,
#                      FBCLymph_transform,
#                      FBCNeutr_transform,
#                      FBCNLR_transform,
#                      FBCWCC_transform,
#                      FER_transform,
#                      fib_transform,
#                      Glucose_transform,
#                      HB_transform,
#                      HBA1c_transform,
#                      LDH_transform,
#                      O2_transform,
#                      PCT_transform,
#                      PLT_transform,
#                      poctLAC_transform,
#                      poctpH_transform,
#                      trig_transform,
#                      trop_transform,
#                      by = c("uob_ID","date"))



```



